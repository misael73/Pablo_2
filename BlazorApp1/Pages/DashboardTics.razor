@page "/dashboard-tics"
@attribute [Authorize]
@inject ApiService ApiService
@inject CustomAuthStateProvider AuthStateProvider
@inject NavigationManager NavigationManager

<PageTitle>Dashboard TICs - SIREFI</PageTitle>

<div class="container-fluid mt-4">
    <h2 class="fw-bold mb-4">
        <i class="bi bi-pc-display"></i> Dashboard TICs / Informática
    </h2>

    @if (!isAuthorized)
    {
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i> No tienes permisos para ver esta página.
        </div>
    }
    else if (isLoading)
    {
        <div class="text-center p-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
    }
    else
    {
        <!-- Stats Cards -->
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="card stat-card bg-info text-white p-3 text-center">
                    <h6>Total TICs</h6>
                    <h2 class="mb-0">@reportes.Count</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card bg-warning text-dark p-3 text-center">
                    <h6>Pendientes</h6>
                    <h2 class="mb-0">@reportes.Count(r => r.EstadoNombre == "Recibido")</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card bg-primary text-white p-3 text-center">
                    <h6>En Proceso</h6>
                    <h2 class="mb-0">@reportes.Count(r => r.EstadoNombre == "En proceso")</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card bg-success text-white p-3 text-center">
                    <h6>Resueltos</h6>
                    <h2 class="mb-0">@reportes.Count(r => r.EstadoNombre == "Resuelto" || r.EstadoNombre == "Solucionado")</h2>
                </div>
            </div>
        </div>

        <!-- Reports Table -->
        <div class="card shadow-sm">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-pc-display"></i> Reportes de Tecnologías de Información</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover align-middle">
                        <thead class="table-info">
                            <tr>
                                <th>Folio</th>
                                <th>Reportante</th>
                                <th>Descripción</th>
                                <th>Ubicación</th>
                                <th>Estado</th>
                                <th>Prioridad</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var reporte in reportes.OrderByDescending(r => r.FechaReporte))
                            {
                                <tr>
                                    <td><strong>@reporte.Folio</strong></td>
                                    <td>@reporte.ReportanteNombre</td>
                                    <td>@TruncateText(reporte.Titulo ?? reporte.Descripcion, 50)</td>
                                    <td>@reporte.EdificioNombre - @reporte.SalonNombre</td>
                                    <td>
                                        <span class="badge @GetStatusClass(reporte.EstadoNombre)">
                                            @reporte.EstadoNombre
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge" style="background-color: @(reporte.PrioridadColor ?? "#6c757d")">
                                            @reporte.PrioridadNombre
                                        </span>
                                    </td>
                                    <td>@reporte.FechaReporte.ToString("dd/MM/yyyy")</td>
                                    <td>
                                        <a href="/reporte/@reporte.Id" class="btn btn-info btn-sm">
                                            <i class="bi bi-eye"></i> Ver
                                        </a>
                                    </td>
                                </tr>
                            }
                            @if (!reportes.Any())
                            {
                                <tr>
                                    <td colspan="8" class="text-center text-muted p-4">
                                        No hay reportes de TICs
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .stat-card {
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .status-resuelto { background-color: #28a745; }
    .status-enproceso { background-color: #ffc107; color: #000; }
    .status-recibido { background-color: #dc3545; }
    .status-default { background-color: #6c757d; }
</style>

@code {
    private List<ReporteDto> reportes = new();
    private UsuarioDto? currentUser;
    private bool isLoading = true;
    private bool isAuthorized = false;

    protected override async Task OnInitializedAsync()
    {
        currentUser = await AuthStateProvider.GetCurrentUserAsync();

        if (currentUser == null)
        {
            NavigationManager.NavigateTo("/login");
            return;
        }

        var role = currentUser.Rol?.ToLower() ?? "";
        isAuthorized = role == "administrador" || role == "tecnico";

        if (isAuthorized)
        {
            await LoadDataAsync();
        }
        else
        {
            isLoading = false;
        }
    }

    private async Task LoadDataAsync()
    {
        isLoading = true;

        try
        {
            // Load reports filtered by dashboard type "tics"
            var response = await ApiService.GetReportesByDashboardAsync("tics");
            if (response?.Success == true && response.Data != null)
            {
                reportes = response.Data;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading data: {ex.Message}");
        }

        isLoading = false;
    }

    private string GetStatusClass(string? estado)
    {
        return estado?.ToLower() switch
        {
            "resuelto" or "solucionado" => "status-resuelto",
            "en proceso" => "status-enproceso",
            "recibido" => "status-recibido",
            _ => "status-default"
        };
    }

    private string TruncateText(string? text, int maxLength)
    {
        if (string.IsNullOrEmpty(text)) return "";
        return text.Length <= maxLength ? text : text.Substring(0, maxLength) + "...";
    }
}
