@page "/exportar-reporte/{Id:int}"
@attribute [Authorize]
@inject ApiService ApiService
@inject CustomAuthStateProvider AuthStateProvider
@inject NavigationManager NavigationManager

@if (isLoading)
{
    <div style="text-align: center; padding: 50px;">
        <p>Cargando documento...</p>
    </div>
}
else if (reporte == null)
{
    <div style="text-align: center; padding: 50px;">
        <p style="color: red;">Reporte no encontrado</p>
        <a href="/mis-reportes">Volver</a>
    </div>
}
else
{
    <!-- Print-ready document matching TECNM template -->
    <style>
        @@page {
            size: letter;
            margin: 1.5cm;
        }
        
        body {
            font-family: Arial, sans-serif;
            font-size: 10pt;
            line-height: 1.3;
            color: #000;
            margin: 0;
            padding: 0;
            background-color: white;
        }
        
        .print-document {
            max-width: 800px;
            margin: 0 auto;
            padding: 15px;
            background-color: white;
        }
        
        .header-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }
        
        .header-table td {
            vertical-align: middle;
            padding: 5px;
        }
        
        .logo-cell {
            width: 120px;
            text-align: center;
        }
        
        .logo-img {
            height: 60px;
            width: auto;
        }
        
        .title-cell {
            text-align: center;
        }
        
        .title-cell h2 {
            margin: 0;
            font-size: 14pt;
            color: #003366;
        }
        
        .title-cell h3 {
            margin: 5px 0 0 0;
            font-size: 12pt;
            font-weight: normal;
            color: #333;
        }
        
        .folio-box {
            border: 2px solid #000;
            padding: 8px 15px;
            text-align: center;
            font-weight: bold;
            font-size: 12pt;
            min-width: 100px;
        }
        
        .main-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .main-table td, .main-table th {
            border: 1px solid #000;
            padding: 6px 8px;
            vertical-align: top;
        }
        
        .section-header {
            background-color: #d9d9d9;
            font-weight: bold;
            text-align: center;
            font-size: 10pt;
        }
        
        .checkbox-section {
            padding: 10px;
        }
        
        .checkbox-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px 20px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 9pt;
        }
        
        .checkbox-box {
            width: 14px;
            height: 14px;
            border: 1px solid #000;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 10pt;
        }
        
        .checkbox-box.checked {
            background-color: #000;
            color: white;
        }
        
        .label-cell {
            background-color: #f0f0f0;
            font-weight: bold;
            width: 35%;
        }
        
        .value-cell {
            width: 65%;
        }
        
        .half-width {
            width: 50%;
        }
        
        .description-area {
            min-height: 120px;
            white-space: pre-wrap;
        }
        
        .signature-section {
            margin-top: 30px;
            text-align: center;
        }
        
        .signature-line {
            width: 300px;
            border-top: 1px solid #000;
            margin: 60px auto 5px auto;
            padding-top: 5px;
            font-size: 9pt;
        }
        
        .print-footer {
            margin-top: 20px;
            text-align: right;
            font-size: 8pt;
            color: #666;
        }
        
        .no-print {
            margin-bottom: 15px;
            text-align: right;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
        
        .no-print button {
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            margin-left: 10px;
            font-size: 14px;
        }
        
        .btn-print {
            background-color: #003366;
            color: white;
        }
        
        .btn-close {
            background-color: #666;
            color: white;
        }
        
        @@media print {
            .no-print { display: none !important; }
            body { padding: 0; margin: 0; }
            .print-document { max-width: none; padding: 0; }
        }
    </style>

    <div class="print-document">
        <!-- Print Button (hidden when printing) -->
        <div class="no-print">
            <button class="btn-print" onclick="window.print()">
                üñ®Ô∏è Imprimir / Guardar como PDF
            </button>
            <button class="btn-close" onclick="history.back()">
                ‚úñ Cerrar
            </button>
        </div>

        <!-- Header with logos and title -->
        <table class="header-table">
            <tr>
                <td class="logo-cell">
                    <!-- TECNM Logo placeholder - blue square with TECNM text -->
                    <div style="background-color: #003366; color: white; padding: 10px; font-size: 10pt; font-weight: bold;">
                        TECNM
                    </div>
                </td>
                <td class="title-cell">
                    <h2>TECNM CAMPUS CIUDAD SERD√ÅN</h2>
                    <h3>Solicitud de mantenimiento correctivo</h3>
                </td>
                <td class="logo-cell">
                    <!-- Secondary logo placeholder -->
                    <div style="background-color: #8B0000; color: white; padding: 10px; font-size: 10pt; font-weight: bold;">
                        ITCS
                    </div>
                </td>
                <td style="width: 120px; text-align: right;">
                    <div class="folio-box">
                        FOLIO<br>
                        @reporte.Folio
                    </div>
                </td>
            </tr>
        </table>

        <!-- Main form content -->
        <table class="main-table">
            <!-- Maintenance Type Section -->
            <tr>
                <td colspan="4" class="section-header">
                    TIPO DE MANTENIMIENTO SOLICITADO
                </td>
            </tr>
            <tr>
                <td colspan="4" class="checkbox-section">
                    <div class="checkbox-grid">
                        <div class="checkbox-item">
                            <span class="checkbox-box @(IsMaintenanceType("Vehicular") ? "checked" : "")">@(IsMaintenanceType("Vehicular") ? "‚úì" : "")</span>
                            <span>Vehicular</span>
                        </div>
                        <div class="checkbox-item">
                            <span class="checkbox-box @(IsMaintenanceType("Aseo") ? "checked" : "")">@(IsMaintenanceType("Aseo") ? "‚úì" : "")</span>
                            <span>Aseo de las √°reas</span>
                        </div>
                        <div class="checkbox-item">
                            <span class="checkbox-box @(IsMaintenanceType("Maquinaria") || IsMaintenanceType("Laboratorio") ? "checked" : "")">@(IsMaintenanceType("Maquinaria") || IsMaintenanceType("Laboratorio") ? "‚úì" : "")</span>
                            <span>Maquinar√≠a de laboratorio</span>
                        </div>
                        <div class="checkbox-item">
                            <span class="checkbox-box @(IsMaintenanceType("C√≥mputo") || IsMaintenanceType("TIC") || IsMaintenanceType("Comunicaciones") ? "checked" : "")">@(IsMaintenanceType("C√≥mputo") || IsMaintenanceType("TIC") || IsMaintenanceType("Comunicaciones") ? "‚úì" : "")</span>
                            <span>Equipo de c√≥mputo y comunicaciones</span>
                        </div>
                        <div class="checkbox-item">
                            <span class="checkbox-box @(IsMaintenanceType("Infraestructura") || IsMaintenanceType("El√©ctric") || IsMaintenanceType("Plomer√≠a") || IsMaintenanceType("Carpinter√≠a") ? "checked" : "")">@(IsMaintenanceType("Infraestructura") || IsMaintenanceType("El√©ctric") || IsMaintenanceType("Plomer√≠a") || IsMaintenanceType("Carpinter√≠a") ? "‚úì" : "")</span>
                            <span>Infraestructura</span>
                        </div>
                        <div class="checkbox-item">
                            <span class="checkbox-box @(IsOtherMaintenanceType() ? "checked" : "")">@(IsOtherMaintenanceType() ? "‚úì" : "")</span>
                            <span>Otros: @(IsOtherMaintenanceType() ? reporte.CategoriaNombre : "")</span>
                        </div>
                    </div>
                </td>
            </tr>

            <!-- Area and Date Row -->
            <tr>
                <td class="label-cell half-width">√ÅREA SOLICITANTE</td>
                <td class="value-cell half-width">@reporte.EdificioNombre @(reporte.SalonNombre != null ? $"- {reporte.SalonNombre}" : "")</td>
                <td class="label-cell" style="width: 20%;">FECHA DE SOLICITUD</td>
                <td class="value-cell" style="width: 20%;">@reporte.FechaReporte.ToString("dd/MM/yyyy")</td>
            </tr>

            <!-- Requester Name and Signature -->
            <tr>
                <td class="label-cell" colspan="2">NOMBRE Y FIRMA DEL SOLICITANTE</td>
                <td class="value-cell" colspan="2">
                    @reporte.ReportanteNombre<br>
                    <small style="color: #666;">@reporte.ReportanteCorreo</small>
                </td>
            </tr>

            <!-- Description Section -->
            <tr>
                <td colspan="4" class="section-header">
                    DESCRIPCI√ìN DEL SERVICIO SOLICITADO O FALLA A REPARAR
                </td>
            </tr>
            <tr>
                <td colspan="4" class="description-area">
                    @reporte.Descripcion
                </td>
            </tr>

            @if (!string.IsNullOrEmpty(ultimaAccion))
            {
                <!-- Actions Section (if there are comments) -->
                <tr>
                    <td colspan="4" class="section-header">
                        SERVICIO REALIZADO / ACCIONES TOMADAS
                    </td>
                </tr>
                <tr>
                    <td colspan="4" class="description-area">
                        @ultimaAccion
                        @if (!string.IsNullOrEmpty(fechaAccion))
                        {
                            <br><small><strong>Fecha:</strong> @fechaAccion</small>
                        }
                    </td>
                </tr>
            }

            <!-- Status and Priority Row (extra info) -->
            <tr>
                <td class="label-cell">PRIORIDAD</td>
                <td class="value-cell">@reporte.PrioridadNombre</td>
                <td class="label-cell">ESTATUS</td>
                <td class="value-cell">@reporte.EstadoNombre</td>
            </tr>

            @if (!string.IsNullOrEmpty(reporte.TecnicoNombre))
            {
                <tr>
                    <td class="label-cell">T√âCNICO ASIGNADO</td>
                    <td class="value-cell" colspan="3">@reporte.TecnicoNombre</td>
                </tr>
            }
        </table>

        <!-- Signature Section -->
        <div class="signature-section">
            <div class="signature-line">
                NOMBRE Y FIRMA DEL SOLICITANTE
            </div>
        </div>

        <!-- Footer -->
        <div class="print-footer">
            Rev. Noviembre 2023
        </div>
    </div>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private ReporteDto? reporte;
    private bool isLoading = true;
    private string ultimaAccion = "";
    private string fechaAccion = "";

    // Known maintenance type keywords for checkbox matching
    private static readonly string[] VehicularKeywords = { "vehicular", "veh√≠culo", "auto", "camioneta", "transporte" };
    private static readonly string[] MaquinariaKeywords = { "maquinaria", "laboratorio", "equipo de lab" };
    private static readonly string[] InfraestructuraKeywords = { "infraestructura", "el√©ctric", "plomer√≠a", "carpinter√≠a", "pintura", "alba√±iler√≠a", "herrer√≠a" };
    private static readonly string[] AseoKeywords = { "aseo", "limpieza", "jardiner√≠a" };
    private static readonly string[] ComputoKeywords = { "c√≥mputo", "computo", "tic", "comunicaciones", "red", "internet", "software", "hardware", "pc", "computadora" };

    protected override async Task OnInitializedAsync()
    {
        var currentUser = await AuthStateProvider.GetCurrentUserAsync();

        if (currentUser == null)
        {
            NavigationManager.NavigateTo("/login");
            return;
        }

        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        isLoading = true;

        try
        {
            // Load report
            var response = await ApiService.GetReporteAsync(Id);
            if (response?.Success == true && response.Data != null)
            {
                reporte = response.Data;
            }

            // Load latest comment
            var commentsResponse = await ApiService.GetComentariosAsync(Id);
            if (commentsResponse?.Success == true && commentsResponse.Data != null && commentsResponse.Data.Any())
            {
                var latestComment = commentsResponse.Data.FirstOrDefault();
                if (latestComment != null)
                {
                    ultimaAccion = latestComment.Comentario ?? "";
                    fechaAccion = latestComment.FechaComentario.ToString("dd/MM/yyyy HH:mm");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading data: {ex.Message}");
        }

        isLoading = false;
    }

    private bool IsMaintenanceType(string keyword)
    {
        if (reporte?.CategoriaNombre == null) return false;
        var categoria = reporte.CategoriaNombre.ToLower();
        return categoria.Contains(keyword.ToLower());
    }

    private bool IsOtherMaintenanceType()
    {
        if (reporte?.CategoriaNombre == null) return false;
        var categoria = reporte.CategoriaNombre.ToLower();
        
        // Check if it doesn't match any of the known categories
        bool isVehicular = VehicularKeywords.Any(k => categoria.Contains(k));
        bool isMaquinaria = MaquinariaKeywords.Any(k => categoria.Contains(k));
        bool isInfraestructura = InfraestructuraKeywords.Any(k => categoria.Contains(k));
        bool isAseo = AseoKeywords.Any(k => categoria.Contains(k));
        bool isComputo = ComputoKeywords.Any(k => categoria.Contains(k));
        
        return !isVehicular && !isMaquinaria && !isInfraestructura && !isAseo && !isComputo;
    }
}
