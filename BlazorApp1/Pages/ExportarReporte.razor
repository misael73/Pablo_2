@page "/exportar-reporte/{Id:int}"
@attribute [Authorize]
@inject ApiService ApiService
@inject CustomAuthStateProvider AuthStateProvider
@inject NavigationManager NavigationManager

@if (isLoading)
{
    <div style="text-align: center; padding: 50px;">
        <p>Cargando documento...</p>
    </div>
}
else if (reporte == null)
{
    <div style="text-align: center; padding: 50px;">
        <p style="color: red;">Reporte no encontrado</p>
        <a href="/mis-reportes">Volver</a>
    </div>
}
else
{
    <!-- Print-ready document matching TECNM Word template exactly -->
    <style>
        @@page {
            size: letter;
            margin: 1.5cm;
        }
        
        body {
            font-family: Arial, sans-serif;
            font-size: 10pt;
            line-height: 1.3;
            color: #000;
            margin: 0;
            padding: 0;
            background-color: white;
        }
        
        .print-document {
            max-width: 800px;
            margin: 0 auto;
            padding: 15px;
            background-color: white;
        }
        
        .folio-table {
            width: auto;
            border-collapse: collapse;
            margin-left: auto;
            margin-bottom: 10px;
        }
        
        .folio-table td {
            border: 1px solid #000;
            padding: 5px 15px;
            font-size: 10pt;
        }
        
        .folio-label {
            background-color: #d9d9d9;
            text-align: right;
            font-weight: normal;
        }
        
        .folio-value {
            text-align: left;
            min-width: 100px;
        }
        
        .main-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 5px;
        }
        
        .main-table td {
            border: 1px solid #000;
            padding: 6px 8px;
            vertical-align: middle;
            font-size: 10pt;
        }
        
        .section-header {
            background-color: #e6e6e6;
            text-align: center;
            font-size: 10pt;
        }
        
        .type-label {
            text-align: right;
            padding-right: 10px;
        }
        
        .type-checkbox {
            text-align: center;
            width: 80px;
        }
        
        .checkbox-x {
            font-weight: bold;
            font-size: 12pt;
        }
        
        .field-label {
            text-align: right;
            padding-right: 8px;
            white-space: nowrap;
        }
        
        .description-cell {
            min-height: 150px;
            vertical-align: top;
            padding: 10px;
        }
        
        .print-footer {
            margin-top: 15px;
            text-align: left;
            font-size: 8pt;
            color: #000;
        }
        
        .no-print {
            margin-bottom: 15px;
            text-align: right;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
        
        .no-print button {
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            margin-left: 10px;
            font-size: 14px;
        }
        
        .btn-print {
            background-color: #003366;
            color: white;
        }
        
        .btn-close {
            background-color: #666;
            color: white;
        }
        
        @@media print {
            .no-print { display: none !important; }
            body { padding: 0; margin: 0; }
            .print-document { max-width: none; padding: 0; }
        }
    </style>

    <div class="print-document">
        <!-- Print Button (hidden when printing) -->
        <div class="no-print">
            <button class="btn-print" onclick="window.print()">
                üñ®Ô∏è Imprimir / Guardar como PDF
            </button>
            <button class="btn-close" onclick="history.back()">
                ‚úñ Cerrar
            </button>
        </div>

        <!-- FOLIO Box (top right, separate table) -->
        <table class="folio-table">
            <tr>
                <td class="folio-label">FOLIO:</td>
                <td class="folio-value">@reporte.Folio</td>
            </tr>
        </table>

        <!-- Main form content -->
        <table class="main-table">
            <!-- TIPO DE MANTENIMIENTO SOLICITADO Header -->
            <tr>
                <td colspan="4" class="section-header">
                    TIPO DE MANTENIMIENTO SOLICITADO:
                </td>
            </tr>
            
            <!-- Row 1: Vehicular | checkbox | Maquinar√≠a de laboratorio | checkbox -->
            <tr>
                <td class="type-label">Vehicular:</td>
                <td class="type-checkbox">
                    <span class="checkbox-x">@(IsMaintenanceType("Vehicular") ? "X" : "")</span>
                </td>
                <td class="type-label">Maquinar√≠a de laboratorio:</td>
                <td class="type-checkbox">
                    <span class="checkbox-x">@(IsMaintenanceType("Maquinaria") || IsMaintenanceType("Laboratorio") ? "X" : "")</span>
                </td>
            </tr>
            
            <!-- Row 2: Infraestructura | checkbox | Aseo de las √°reas | checkbox -->
            <tr>
                <td class="type-label">Infraestructura:</td>
                <td class="type-checkbox">
                    <span class="checkbox-x">@(IsMaintenanceType("Infraestructura") || IsMaintenanceType("El√©ctric") || IsMaintenanceType("Plomer√≠a") || IsMaintenanceType("Carpinter√≠a") ? "X" : "")</span>
                </td>
                <td class="type-label">Aseo de las √°reas:</td>
                <td class="type-checkbox">
                    <span class="checkbox-x">@(IsMaintenanceType("Aseo") ? "X" : "")</span>
                </td>
            </tr>
            
            <!-- Row 3: Equipo de c√≥mputo y comunicaciones | checkbox | Otros | checkbox -->
            <tr>
                <td class="type-label">Equipo de c√≥mputo y comunicaciones:</td>
                <td class="type-checkbox">
                    <span class="checkbox-x">@(IsMaintenanceType("C√≥mputo") || IsMaintenanceType("TIC") || IsMaintenanceType("Comunicaciones") ? "X" : "")</span>
                </td>
                <td class="type-label">Otros:</td>
                <td class="type-checkbox">
                    <span class="checkbox-x">@(IsOtherMaintenanceType() ? "X" : "")</span>
                </td>
            </tr>

            <!-- √ÅREA SOLICITANTE / FECHA DE SOLICITUD DE MANTENIMIENTO Row -->
            <tr>
                <td class="field-label">√ÅREA SOLICITANTE:</td>
                <td>@GetAreaSolicitante()</td>
                <td class="field-label">FECHA DE SOLICITUD DE MANTENIMIENTO:</td>
                <td>@FormatFecha(reporte.FechaReporte)</td>
            </tr>

            <!-- NOMBRE Y FIRMA DEL SOLICITANTE Row -->
            <tr>
                <td class="field-label">NOMBRE Y FIRMA DEL SOLICITANTE:</td>
                <td colspan="3">C. @reporte.ReportanteNombre</td>
            </tr>

            <!-- DESCRIPCI√ìN DEL SERVICIO SOLICITADO O FALLA A REPARAR Header -->
            <tr>
                <td colspan="4" class="section-header">
                    DESCRIPCI√ìN DEL SERVICIO SOLICITADO O FALLA A REPARAR:
                </td>
            </tr>
            
            <!-- Description content -->
            <tr>
                <td colspan="4" class="description-cell">
                    @reporte.Descripcion
                    @if (!string.IsNullOrEmpty(reporte.EdificioNombre) || !string.IsNullOrEmpty(reporte.SalonNombre))
                    {
                        <br/><br/>
                        <strong>Ubicaci√≥n:</strong> @reporte.EdificioNombre @(reporte.SalonNombre != null ? $", {reporte.SalonNombre}" : "")
                    }
                </td>
            </tr>
        </table>

        <!-- Footer -->
        <div class="print-footer">
            Rev. Noviembre 2023
        </div>
    </div>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private ReporteDto? reporte;
    private bool isLoading = true;

    // Known maintenance type keywords for checkbox matching
    private static readonly string[] VehicularKeywords = { "vehicular", "veh√≠culo", "auto", "camioneta", "transporte" };
    private static readonly string[] MaquinariaKeywords = { "maquinaria", "laboratorio", "equipo de lab" };
    private static readonly string[] InfraestructuraKeywords = { "infraestructura", "el√©ctric", "plomer√≠a", "carpinter√≠a", "pintura", "alba√±iler√≠a", "herrer√≠a" };
    private static readonly string[] AseoKeywords = { "aseo", "limpieza", "jardiner√≠a" };
    private static readonly string[] ComputoKeywords = { "c√≥mputo", "computo", "tic", "comunicaciones", "red", "internet", "software", "hardware", "pc", "computadora" };

    protected override async Task OnInitializedAsync()
    {
        var currentUser = await AuthStateProvider.GetCurrentUserAsync();

        if (currentUser == null)
        {
            NavigationManager.NavigateTo("/login");
            return;
        }

        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        isLoading = true;

        try
        {
            // Load report
            var response = await ApiService.GetReporteAsync(Id);
            if (response?.Success == true && response.Data != null)
            {
                reporte = response.Data;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading data: {ex.Message}");
        }

        isLoading = false;
    }

    private bool IsMaintenanceType(string keyword)
    {
        if (reporte?.CategoriaNombre == null) return false;
        var categoria = reporte.CategoriaNombre.ToLower();
        return categoria.Contains(keyword.ToLower());
    }

    private bool IsOtherMaintenanceType()
    {
        if (reporte?.CategoriaNombre == null) return false;
        var categoria = reporte.CategoriaNombre.ToLower();
        
        // Check if it doesn't match any of the known categories
        bool isVehicular = VehicularKeywords.Any(k => categoria.Contains(k));
        bool isMaquinaria = MaquinariaKeywords.Any(k => categoria.Contains(k));
        bool isInfraestructura = InfraestructuraKeywords.Any(k => categoria.Contains(k));
        bool isAseo = AseoKeywords.Any(k => categoria.Contains(k));
        bool isComputo = ComputoKeywords.Any(k => categoria.Contains(k));
        
        return !isVehicular && !isMaquinaria && !isInfraestructura && !isAseo && !isComputo;
    }

    private string GetAreaSolicitante()
    {
        // Return department/area from user's department if available, otherwise use building name
        if (reporte?.ReportanteDepartamento != null && !string.IsNullOrEmpty(reporte.ReportanteDepartamento))
        {
            return reporte.ReportanteDepartamento;
        }
        return reporte?.EdificioNombre ?? "";
    }

    private string FormatFecha(DateTime fecha)
    {
        // Format as "22 de octubre de 2025"
        var meses = new[] { "", "enero", "febrero", "marzo", "abril", "mayo", "junio", 
                          "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre" };
        return $"{fecha.Day} de {meses[fecha.Month]} de {fecha.Year}";
    }
}
