@page "/dashboard"
@attribute [Authorize]
@inject ApiService ApiService
@inject CustomAuthStateProvider AuthStateProvider
@inject NavigationManager NavigationManager

<PageTitle>Dashboard - SIREFI</PageTitle>

<div class="container-fluid mt-4">
    <h2 class="fw-bold mb-4">
        <i class="bi bi-speedometer2"></i> Dashboard General
    </h2>

    @if (!isAuthorized)
    {
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i> No tienes permisos para ver esta página.
        </div>
    }
    else if (isLoading)
    {
        <div class="text-center p-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2">Cargando reportes...</p>
        </div>
    }
    else
    {
        <!-- Stats Cards -->
        <div class="row g-4 mb-4">
            <div class="col-md-2">
                <div class="card stat-card bg-primary text-white p-3 text-center">
                    <h6>Total</h6>
                    <h2 class="mb-0">@stats.Total</h2>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stat-card bg-warning text-dark p-3 text-center">
                    <h6>Pendientes</h6>
                    <h2 class="mb-0">@stats.Pendientes</h2>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stat-card bg-info text-white p-3 text-center">
                    <h6>En Proceso</h6>
                    <h2 class="mb-0">@stats.EnProceso</h2>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stat-card bg-success text-white p-3 text-center">
                    <h6>Resueltos</h6>
                    <h2 class="mb-0">@stats.Resueltos</h2>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stat-card bg-danger text-white p-3 text-center">
                    <h6>Retrasados</h6>
                    <h2 class="mb-0">@stats.Retrasados</h2>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stat-card bg-secondary text-white p-3 text-center">
                    <h6>Hoy</h6>
                    <h2 class="mb-0">@stats.Hoy</h2>
                </div>
            </div>
        </div>

        <!-- Reports Table -->
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-table"></i> Todos los Reportes</h5>
                <span class="badge bg-light text-primary">@reportes.Count reportes</span>
            </div>
            <div class="card-body">
                <!-- Filter -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <input type="text" class="form-control" placeholder="Buscar por folio, descripción..." 
                               @bind="searchTerm" @bind:event="oninput" />
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" @bind="filterEstado">
                            <option value="">Todos los estados</option>
                            <option value="Recibido">Recibido</option>
                            <option value="En proceso">En proceso</option>
                            <option value="Resuelto">Resuelto</option>
                        </select>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-bordered table-hover align-middle">
                        <thead class="table-primary">
                            <tr>
                                <th>Folio</th>
                                <th>Reportante</th>
                                <th>Descripción</th>
                                <th>Ubicación</th>
                                <th>Categoría</th>
                                <th>Estado</th>
                                <th>Prioridad</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var reporte in FilteredReportes)
                            {
                                <tr>
                                    <td><strong>@reporte.Folio</strong></td>
                                    <td>@reporte.ReportanteNombre</td>
                                    <td>@TruncateText(reporte.Titulo ?? reporte.Descripcion, 40)</td>
                                    <td>@reporte.EdificioNombre - @reporte.SalonNombre</td>
                                    <td>@reporte.CategoriaNombre</td>
                                    <td>
                                        <span class="badge @GetStatusClass(reporte.EstadoNombre)">
                                            @reporte.EstadoNombre
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge" style="background-color: @(reporte.PrioridadColor ?? "#6c757d")">
                                            @reporte.PrioridadNombre
                                        </span>
                                    </td>
                                    <td>@reporte.FechaReporte.ToString("dd/MM/yyyy")</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="/reporte/@reporte.Id" class="btn btn-info" title="Ver">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            @if (isAdmin)
                                            {
                                                <a href="/editar-reporte/@reporte.Id" class="btn btn-warning" title="Editar">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                            @if (!FilteredReportes.Any())
                            {
                                <tr>
                                    <td colspan="9" class="text-center text-muted p-4">
                                        No se encontraron reportes
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .stat-card {
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .stat-card h6 {
        font-size: 0.85rem;
        margin-bottom: 5px;
    }
    .status-resuelto { background-color: #28a745; }
    .status-enproceso { background-color: #ffc107; color: #000; }
    .status-recibido { background-color: #dc3545; }
    .status-default { background-color: #6c757d; }
</style>

@code {
    private List<ReporteDto> reportes = new();
    private ReporteStatsDto stats = new();
    private UsuarioDto? currentUser;
    private bool isLoading = true;
    private bool isAuthorized = false;
    private bool isAdmin = false;
    private string searchTerm = "";
    private string filterEstado = "";

    private IEnumerable<ReporteDto> FilteredReportes => reportes
        .Where(r => string.IsNullOrEmpty(searchTerm) || 
                    r.Folio.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                    (r.Descripcion?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (r.Titulo?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false))
        .Where(r => string.IsNullOrEmpty(filterEstado) || r.EstadoNombre == filterEstado)
        .OrderByDescending(r => r.FechaReporte);

    protected override async Task OnInitializedAsync()
    {
        currentUser = await AuthStateProvider.GetCurrentUserAsync();

        if (currentUser == null)
        {
            NavigationManager.NavigateTo("/login");
            return;
        }

        var role = currentUser.Rol?.ToLower() ?? "";
        isAdmin = role == "administrador";
        isAuthorized = role == "administrador" || role == "tecnico";

        if (isAuthorized)
        {
            await LoadDataAsync();
        }
        else
        {
            isLoading = false;
        }
    }

    private async Task LoadDataAsync()
    {
        isLoading = true;

        try
        {
            // Load all reports (not filtered by user)
            var reportesResponse = await ApiService.GetAllReportesAsync();
            if (reportesResponse?.Success == true && reportesResponse.Data != null)
            {
                reportes = reportesResponse.Data;
            }

            // Load stats for all reports
            var statsResponse = await ApiService.GetReporteStatsAsync(null);
            if (statsResponse?.Success == true && statsResponse.Data != null)
            {
                stats = statsResponse.Data;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading data: {ex.Message}");
        }

        isLoading = false;
    }

    private string GetStatusClass(string? estado)
    {
        return estado?.ToLower() switch
        {
            "resuelto" or "solucionado" => "status-resuelto",
            "en proceso" => "status-enproceso",
            "recibido" => "status-recibido",
            _ => "status-default"
        };
    }

    private string TruncateText(string? text, int maxLength)
    {
        if (string.IsNullOrEmpty(text)) return "";
        return text.Length <= maxLength ? text : text.Substring(0, maxLength) + "...";
    }
}
