@page "/mis-reportes"
@attribute [Authorize]
@inject ApiService ApiService
@inject CustomAuthStateProvider AuthStateProvider
@inject NavigationManager NavigationManager

<PageTitle>Mis Reportes - SIREFI</PageTitle>

<div class="container mt-4">
    <h2 class="fw-bold mb-4 text-center">Mis Reportes</h2>

    @if (isLoading)
    {
        <div class="text-center p-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2">Cargando reportes...</p>
        </div>
    }
    else
    {
        <!-- Stats Cards -->
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="card stat-card p-4 text-center">
                    <h5>Total Reportes</h5>
                    <p class="stat-value text-primary">@stats.Total</p>
                    <p class="text-muted">Hoy: @stats.Hoy</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card p-4 text-center">
                    <h5>En Proceso</h5>
                    <p class="stat-value text-info">@stats.EnProceso</p>
                    <p class="text-muted">Atendiendo</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card p-4 text-center">
                    <h5>Resueltos</h5>
                    <p class="stat-value text-success">@stats.Resueltos</p>
                    <p class="text-muted">@(stats.Total > 0 ? Math.Round((decimal)stats.Resueltos / stats.Total * 100, 1) : 0)% completado</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card p-4 text-center">
                    <h5>Pendientes</h5>
                    <p class="stat-value text-warning">@stats.Pendientes</p>
                    <p class="text-muted">Sin atender</p>
                </div>
            </div>
        </div>

        <!-- Reports Table -->
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="section-title mb-0">Mis Reportes</h4>
                    <a href="/nuevo-reporte" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Nuevo Reporte
                    </a>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-bordered table-striped align-middle">
                        <thead class="table-primary">
                            <tr>
                                <th class="text-center">Folio</th>
                                <th>Descripción</th>
                                <th class="text-center">Área</th>
                                <th class="text-center">Tipo</th>
                                <th class="text-center">Estatus</th>
                                <th>Última Acción</th>
                                <th class="text-center">Fecha</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (reportes.Any())
                            {
                                @foreach (var reporte in reportes)
                                {
                                    <tr>
                                        <td class="text-center">@reporte.Folio</td>
                                        <td>@(reporte.Titulo ?? reporte.Descripcion)</td>
                                        <td class="text-center">@($"{reporte.EdificioNombre} - {reporte.SalonNombre}")</td>
                                        <td class="text-center">@reporte.CategoriaNombre</td>
                                        <td class="text-center">
                                            <span class="badge @GetStatusClass(reporte.EstadoNombre)">
                                                @reporte.EstadoNombre
                                            </span>
                                        </td>
                                        <td>@(reporte.UltimaAccion ?? "Sin acciones registradas")</td>
                                        <td class="text-center">@reporte.FechaReporte.ToString("dd/MM/yyyy HH:mm")</td>
                                        <td class="text-center">
                                            <a href="/reporte/@reporte.Id" class="btn btn-info btn-sm">
                                                <i class="bi bi-eye"></i> Ver
                                            </a>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="8" class="text-center p-5">
                                        <i class="bi bi-inbox" style="font-size: 48px; color: #ccc;"></i>
                                        <p class="text-muted mt-3">No tienes reportes registrados</p>
                                        <a href="/nuevo-reporte" class="btn btn-primary mt-2">
                                            <i class="bi bi-plus-circle"></i> Crear primer reporte
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .stat-card {
        border-radius: 15px;
        border: none;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    
    .stat-value {
        font-size: 28px;
        font-weight: bold;
    }
    
    .section-title {
        font-weight: bold;
        color: #333;
    }
    
    .badge {
        font-size: 0.85rem;
        padding: 0.5em 1em;
    }
    
    .status-resuelto {
        background-color: #00c851;
    }
    
    .status-enproceso {
        background-color: #ffeb3b;
        color: black;
    }
    
    .status-recibido {
        background-color: #ff4444;
    }
    
    .status-default {
        background-color: #6c757d;
    }
</style>

@code {
    private List<ReporteDto> reportes = new();
    private ReporteStatsDto stats = new();
    private bool isLoading = true;
    private UsuarioDto? currentUser;

    protected override async Task OnInitializedAsync()
    {
        currentUser = await AuthStateProvider.GetCurrentUserAsync();
        
        if (currentUser == null)
        {
            NavigationManager.NavigateTo("/login");
            return;
        }

        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        isLoading = true;

        try
        {
            // Load reports
            var reportesResponse = await ApiService.GetReportesAsync(currentUser?.Id);
            if (reportesResponse?.Success == true && reportesResponse.Data != null)
            {
                reportes = reportesResponse.Data;
            }

            // Load stats
            var statsResponse = await ApiService.GetReporteStatsAsync(currentUser?.Id);
            if (statsResponse?.Success == true && statsResponse.Data != null)
            {
                stats = statsResponse.Data;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading data: {ex.Message}");
        }

        isLoading = false;
    }

    private string GetStatusClass(string? estado)
    {
        return estado?.ToLower() switch
        {
            "resuelto" => "status-resuelto",
            "en proceso" => "status-enproceso",
            "recibido" => "status-recibido",
            _ => "status-default"
        };
    }
}
